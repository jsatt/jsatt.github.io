<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width">
<title>Class-based Celery Tasks</title>
<link rel=alternate type=application/rss+xml title=RSS href=https://jsatt.com/blog/feeds/rss/>
<link rel=alternate type=application/atom+xml title=Atom href=https://jsatt.com/blog/feeds/atom/>
<link rel=stylesheet href=../../static/css/bootstrap.min.css>
<link rel=stylesheet href=../../static/css/font-awesome.min.css>
<link rel=stylesheet href=../../static/css/prism.css>
<link rel=stylesheet href=../../static/css/main.css>
</head>
<body id=page_blog_post><header>
<nav>
<div class=container>
<div class=row>
<div class=col-md-12>
<ul class="nav navbar-nav">
<li id=menu-link-blog><a href=https://jsatt.com/blog/>Blog</a></li>
<li id=menu-link-about><a href=https://jsatt.com/about/>About</a></li>
</ul>
</div>
</div>
</div>
</nav>
<div class=title><a href=../../>Jeremy Satterfield</a></div>
<div class=tagline>Coding, Making and Tulsa Life</div>
</header>
<section id=content>
<div class=container>
<div class=row>
<article class=col-md-8 itemscope itemtype=http://schema.org/BlogPosting>
<h1 class=headline itemprop=headline>Class-based Celery Tasks</h1>
<h6 class=post-meta>
Posted by:
<span itemscope itemprop=author itemtype=http://schema.org/Person>
<span itemprop=name>Jeremy Satterfield</span>
</span>
in
<a itemprop=articleSection href=https://jsatt.com/categories/development/>development</a>
on <span itemprop=datePublished>2014-06-05</span>
<ul class="list-inline tags">
<li>Tags:</li>
<li><a href=https://jsatt.com/tags/python/>python</a></li><li><a href=https://jsatt.com/tags/celery/>celery</a></li><li><a href=https://jsatt.com/tags/hacks/>hacks</a></li>
</ul>
</h6>
<div class=post itemprop=articleBody>
<p>Update 2017-11-02: Celery 4 now <a href=http://docs.celeryproject.org/en/latest/whatsnew-4.0.html#the-task-base-class-no-longer-automatically-register-tasks>adivises against inheriting from Task</a> unless you are extending common functionality. However you can still get similar functionality by creating a new class and calling is from inside a decorated function task.</p>
<pre>
<code>class MyTask(object):
    def run(self, source):
        do_stuff()
    ...

@app.task
def my_task(source):
    MyTask().run(source)
</code></pre>
<p>Original Post:</p>
<p>Recently, I've had to write several complicated Celery tasks. Unfortunately, when doing a complicated process standard task functions can become unwieldy to write, read and unit test. After looking into how Celery tasks actually work, I was able to find a more manageable way of writing these complex tasks.</p>
<p>It turns out the <code>task</code> decorator that you're used to using is just an object factory for <code>Task</code> objects that turns the decorated function into the <code>run</code> method of on the <code>Task</code> instance it creates. Skipping the decorator and extending the <code>Task</code> class directly makes things a little more flexible.</p>
<pre>
<code class=language-python>from celery import Task


class MyTask(Task):
    ignore_result = True

    def run(self, source, *args, **kwargs):
        self.source = source
        data = self.collect_data()
        self.generate_file(data)

    def generate_file(self, data):
        # do your file generation here
        ...
    
    def collect_data(self):
        # do your data collection here
        ...
        return data</code>
</pre>
<p>In this case <code>run</code> is the equivalent of the function task you're used to, but thanks to OOP you're free to break some of the more complex code into logic blocks, <code>collect_data</code> and <code>generate_file</code>, and access to instance attribute, <code>source</code>.</p>
<p>To call the task your just need to instantiate the it and call the desired method to trigger it.</p>
<pre>
<code class=language-python>task = MyTask()

# Run on Celery worker now
task.delay(123)

# Run on Celery worker at a sepcfic time 
task.apply_async(args=[123], eta=datetime(2015, 6, 5, 12, 30, 22))

# Run task directly, No celery worker
task.run(123)
task(123)
</code></pre>
<p>Testing also now becomes easier as well since you can test each unit on it's own.</p>
<p>For most cases, your standard function-based classes are probably going to do the job. But for those extra complex cases, class-based might make things easier work with.</p>
</div>
</article>
<aside class=col-md-4>
<nav class=social-icons>
<a href=https://github.com/jsatt rel=me target=_blank><i class="fa fa-github-square"></i></a>
<a href=https://www.facebook.com/jsatt0 rel=me target=_blank><i class="fa fa-facebook-square"></i></a>
<a href=https://twitter.com/jsatt rel=me target=_blank><i class="fa fa-twitter-square"></i></a>
<a href=https://www.linkedin.com/in/jsatterfield rel=me target=_blank><i class="fa fa-linkedin-square"></i></a>
<a href=mailto:jsatt@jsatt.com><i class="fa fa-envelope"></i></a>
<a href target=_blank><i class="fa fa-rss-square"></i></a>
</nav>
<div class=keywords>
<div class=keyword>
<a href=https://jsatt.com/tags/python/>#python</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/testing/>#testing</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/django/>#django</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/hacks/>#hacks</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/mocking/>#mocking</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/django-rest-framework/>#django-rest-framework</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/celery/>#celery</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/class-based-views/>#class-based-views</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/data-structures/>#data-structures</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/dev-ops/>#dev-ops</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/docker/>#docker</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/go/>#go</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/linux/>#linux</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/node/>#node</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/nose/>#nose</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/open-source/>#open-source</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/packages/>#packages</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/ruby/>#ruby</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/rust/>#rust</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/tox/>#tox</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/travis-ci/>#travis-ci</a>
</div>
<div class=keyword>
<a href=https://jsatt.com/tags/virtualenvs/>#virtualenvs</a>
</div>
</div>
</aside>
</div>
</div>
</section><footer>
<div class=container>
<div class=row>
<div class=col-md-12>
<div class=nav-footer>
<ul class=list-unstyled>
<li id=footer-menu-presentations><a href=https://jsatt.com/presentations/>Presentations</a></li>
<li id=footer-menu-resume><a href=https://jsatt.com/resume/>Resume</a></li>
</ul>
</div>
</div>
</div>
</div>
</footer>
<script src=../../static/js/jquery.min.js></script>
<script src=../../static/js/prism.js></script>
<script src=../../static/js/bootstrap.min.js></script>
</body>
</html>