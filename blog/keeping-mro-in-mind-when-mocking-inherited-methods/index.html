<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width">
<title>Keeping MRO In Mind When Mocking Inherited Methods</title>
<link rel=alternate type=application/rss+xml title=RSS href=https://jsatt.github.io/blog/feeds/rss/>
<link rel=alternate type=application/atom+xml title=Atom href=https://jsatt.github.io/blog/feeds/atom/>
<link rel=stylesheet href=../../static/css/bootstrap.min.css>
<link rel=stylesheet href=../../static/css/font-awesome.min.css>
<link rel=stylesheet href=../../static/css/prism.css>
<link rel=stylesheet href=../../static/css/main.css>
</head>
<body id=page_blog_post><header>
<nav>
<div class=container>
<div class=row>
<div class=col-md-12>
<ul class="nav navbar-nav">
<li id=menu-link-blog><a href=https://jsatt.github.io/blog/>Blog</a></li>
<li id=menu-link-about><a href=https://jsatt.github.io/about/>About</a></li>
</ul>
</div>
</div>
</div>
</nav>
<div class=title><a href=../../>Jeremy Satterfield</a></div>
<div class=tagline>Coding, Making and Tulsa Life</div>
</header>
<section id=content>
<div class=container>
<div class=row>
<article class=col-md-8 itemscope itemtype=http://schema.org/BlogPosting>
<h1 class=headline itemprop=headline>Keeping MRO In Mind When Mocking Inherited Methods</h1>
<h6 class=post-meta>
Posted by:
<span itemscope itemprop=author itemtype=http://schema.org/Person>
<span itemprop=name>Jeremy Satterfield</span>
</span>
in
<a itemprop=articleSection href=https://jsatt.github.io/categories/development/>development</a>
on <span itemprop=datePublished>2014-10-16</span>
<ul class="list-inline tags">
<li>Tags:</li>
<li><a href=https://jsatt.github.io/tags/mocking/>mocking</a></li><li><a href=https://jsatt.github.io/tags/python/>python</a></li><li><a href=https://jsatt.github.io/tags/testing/>testing</a></li>
</ul>
</h6>
<div class=post itemprop=articleBody>
<p>So I just spent a couple of hours banging my head on a ridiculous PyMox mocking issue and though I'd share. Here is an example of the existing code.</p>
<pre class=language-python>
<code># views.py
class MyBaseView(BaseView):
    def get_stuff(self):
        # this is doing things

class SpecificView(MyBaseView):
    example = True

    def send_stuff(self):
        stuff = self.get_stuff()
        # do other things


# tests.py
class SpecificViewTest(TestCase):
   def setUp(self):
       self.view = SpecificView()
       self.mox = mox.Mox()

   def tearDown(self):
       self.mox.UnsetStubs()

   def test_send_stuff(self):
       self.mox.StubOutWithMock(MyBaseView, &#39;get_stuff&#39;)
       MyBaseView.get_stuff().AndReturn([&#39;list&#39;, &#39;of&#39;, &#39;things&#39;])

       self.mox.ReplayAll()
       self.view.send_stuff()
       self.mox.VerifyAll()

       # do assertions
</code></pre>
<p>This was all fine and working for months, until I added the following.</p>
<pre>
<code># views.py
class ExtraSpecificView(SpecificView):
    def other_stuff(self):
        self.get_stuff()
        # do more things again

# test.py
class ExtraSpecificViewTest(TestCase):
   def setUp(self):
       self.view = ExtraSpecificView()
       self.mox = mox.Mox()

   def tearDown(self):
       self.mox.UnsetStubs()

   def test_other_stuff(self):
       self.mox.StubOutWithMox(SpecifcView, &#39;get_stuff&#39;)
       SpecificView.get_stuff().AndReturn([&#39;more&#39;, &#39;things&#39;])

       self.mox.ReplayAll()
       self.view.other_stuff()
       self.mox.VerifyAll()
</code></pre>
<p>So what started happening at this point is <code>SpecificViewTest.test_send_stuff</code> began failing with this.</p>
<pre>
<code>ExpectedMethodCallsError: Verify: Expected methods never called:
  0.  get_stuff.__call__() -&gt; [&#39;list&#39;, &#39;of&#39;, &#39;things&#39;]</code></pre>
<p>It would only fail when <code>ExtraSpecificViewTest</code> ran before <code>SpecificViewTest</code> which, with nose, it does by default. So I knew it had to have something to do with the mocking in <code>ExtraSpecificViewTest.test_other_stuff</code>. After more playing and banging my head I came up with this working theory which seems correct the more I think on it.</p>
<p>When you mock out a method on a class, the mocking library stores the original method and replaces it with the mock function. When you tell the library to stop mocking the method, <code>mox.UnsetStubs</code> in this case, it grabs that original method it stored before and assigns it back to the appropriate attribute on the class, restoring it's original functionality.</p>
<p>However, in my class I was mocking a method that <code>SpecificView</code> inherited from <code>MyBaseView</code>. When the library grabs the original method for storing Python sees that SpecificView doesn't have a <code>get_stuff</code> method of it's own, so it moves up the <abbr title="Method Resolution Order">MRO</abbr> and grabs <code>MyBaseView.get_stuff</code> and the library stores that and assigns a mock function to the <code>get_stuff</code> attribute on the <strong>class</strong> of <code>SpecificView</code>. Then, when the library goes to un-stub the method, it grabs the stored <code>get_stuff</code> Python gave it from <code>MyBaseView</code> and assigns it also to the <code>get_stuff</code> attribute of the <strong>class</strong> of <code>SpecificView</code>. Finally, when <code>SpecificViewTest.test_set_stuff</code> runs, <code>send_stuff</code> calls <code>SpecificView</code>'s <code>get_stuff</code>, instead of moving up the MRO as to used to, Python now sees that the <code>SpecificView</code> class has it's own <code>get_stuff</code> method (which doesn't have a super call), so it doesn't move up the MRO, therefore <code>MyBaseView</code> is never called as expected and raising a failure when verified.</p>
<p>So this became the fix.</p>
<pre>
<code>#tests.py
class ExtraSpecificViewTest(TestCase):
    ...   
    def test_other_stuff(self):
       self.mox.StubOutWithMox(MyBaseView, &#39;get_stuff&#39;)
       MyBaseView.get_stuff().AndReturn([&#39;more&#39;, &#39;things&#39;])
</code></pre>
<p>It's a convoluted bug that may or may not be specific to PyMox or other mocking libraries, but I'm not sure how they should be properly handling something like this. So I guess the moral of the story is to mock methods from the class which the were originally defined, not just the class you inherited from.</p>
</div>
</article>
<aside class=col-md-4>
<nav class=social-icons>
<a href=https://github.com/jsatt rel=me target=_blank><i class="fa fa-github-square"></i></a>
<a href=https://www.facebook.com/jsatt0 rel=me target=_blank><i class="fa fa-facebook-square"></i></a>
<a href=https://twitter.com/jsatt rel=me target=_blank><i class="fa fa-twitter-square"></i></a>
<a href=https://www.linkedin.com/in/jsatterfield rel=me target=_blank><i class="fa fa-linkedin-square"></i></a>
<a href=mailto:jsatt@jsatt.com><i class="fa fa-envelope"></i></a>
<a href target=_blank><i class="fa fa-rss-square"></i></a>
</nav>
<div id=related-posts>
<div class=related-post>
<a href=https://jsatt.github.io/blog/mocking-a-property-in-python/>Mocking a property in Python</a>
<div class=timesince>2014-08-08</div>
</div>
<div class=related-post>
<a href=https://jsatt.github.io/blog/mocking-pythons-built-in-open-function/>Mocking Python&amp;#39;s built-in open function</a>
<div class=timesince>2014-04-11</div>
</div>
</div>
<div class=keywords>
<div class=keyword>
<a href=https://jsatt.github.io/tags/python/>#python</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/testing/>#testing</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/django/>#django</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/hacks/>#hacks</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/mocking/>#mocking</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/django-rest-framework/>#django-rest-framework</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/celery/>#celery</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/class-based-views/>#class-based-views</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/data-structures/>#data-structures</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/dev-ops/>#dev-ops</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/docker/>#docker</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/go/>#go</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/linux/>#linux</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/node/>#node</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/nose/>#nose</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/open-source/>#open-source</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/packages/>#packages</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/ruby/>#ruby</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/rust/>#rust</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/tox/>#tox</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/travis-ci/>#travis-ci</a>
</div>
<div class=keyword>
<a href=https://jsatt.github.io/tags/virtualenvs/>#virtualenvs</a>
</div>
</div>
</aside>
</div>
</div>
</section><footer>
<div class=container>
<div class=row>
<div class=col-md-12>
<div class=nav-footer>
<ul class=list-unstyled>
<li id=footer-menu-presentations><a href=https://jsatt.github.io/presentations/>Presentations</a></li>
<li id=footer-menu-resume><a href=https://jsatt.github.io/resume/>Resume</a></li>
</ul>
</div>
</div>
</div>
</div>
</footer>
<script src=../../static/js/jquery.min.js></script>
<script src=../../static/js/prism.js></script>
<script src=../../static/js/bootstrap.min.js></script>
</body>
</html>