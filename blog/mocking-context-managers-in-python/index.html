<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width"><title>Mocking Context Managers in Python</title><link rel=alternate type=application/rss+xml title=RSS href=https://jsatt.com/blog/feeds/rss/><link rel=alternate type=application/atom+xml title=Atom href=https://jsatt.com/blog/feeds/atom/><link rel=stylesheet href=../../static/css/bootstrap.min.css><link rel=stylesheet href=../../static/css/fontawesome.min.css><link rel=stylesheet href=../../static/css/prism.css><link rel=stylesheet href=../../static/css/main.css></head><body id=page_blog_post><header><nav><div class=container><div class=row><div class=col-md-12><ul class="nav navbar-nav"><li id=menu-link-blog><a href=https://jsatt.com/blog/>Blog</a></li><li id=menu-link-about><a href=https://jsatt.com/about/>About</a></li></ul></div></div></div></nav><div class=title><a href=../../>Jeremy Satterfield</a></div><div class=tagline>Coding, Making and Tulsa Life</div></header><section id=content><div class=container><div class=row><article class=col-md-8 itemscope itemtype=http://schema.org/BlogPosting><h1 class=headline itemprop=headline>Mocking Context Managers in Python</h1><h6 class=post-meta>Posted by:
<span itemscope itemprop=author itemtype=http://schema.org/Person><span itemprop=name>Jeremy Satterfield</span></span>
in
<a itemprop=articleSection href=https://jsatt.com/categories/development/>development</a>
on <span itemprop=datePublished>2014-02-28</span><ul class="list-inline tags"><li>Tags:</li><li><a href=https://jsatt.com/tags/python/>python</a></li><li><a href=https://jsatt.com/tags/testing/>testing</a></li></ul></h6><div class=post itemprop=articleBody><p>I've often found Python's context managers to be pretty useful. They make a nice interface that can handle starting and ending of temporary things for you, like opening and closing a file.</p><p>For example:</p><pre>
<code class=language-python>f = open(&#39;myfile.txt&#39;, &#39;w&#39;)
try:
    for row in records:
        f.write(row)
finally:
     f.close()</code></pre><p>can be replaced with</p><pre>
<code class=language-python>with open(&#39;myfile.txt&#39;, &#39;w&#39;) as f:
    for row in records:
        f.write(row)</code></pre><p>This last week I was working with the ZipFile module and wanted to use it's context manger interface, but I ran into a little confusion when it came to unit testing. After a little better understanding of how context managers work, I figured out that the <code>__enter__</code> and <code>__exit__</code> methods are what really makes a context handler. As <a href=http://pymotw.com/2/contextlib/>explained at PyMOTW</a>, when you invoke <code>with</code> on a class, __enter__ is called and should return an object to be used in the context (<code>f</code> in the above example), the code within the block is executed, and <code>__exit__</code> is called no matter the outcome of the block. So both of these would be roughly equivalent, assuming <code>do_stuff</code> doesn't raise an exception.</p><pre>
<code class=language-python>with Context(foo) as bar:
    do_stuff(bar)

c = Context(foo)
bar = c.__enter__()
try:
    do_stuff(bar)
finally:
    c.__exit__(None, None, None)</code></pre><p>With this understanding, here is the solution to my mocking problem using PyMox.</p><pre>
<code class=language-python>#module/tasks.py
def zip_it_up(filename):
    with ZipFile(filename, &#39;w&#39;) as f:
        for file in FILES:
            f.write(file.path, file.name)

# tests.py
... # setup and stuff is up here somewhere
def test_building_zipfile(self):
    self.mock.StubOutWithMock(module.tasks, &#39;ZipFile&#39;)
&nbsp;&nbsp;&nbsp; mock_zip = self.mock.CreateMockAnything()
&nbsp;&nbsp;&nbsp; module.tasks.ZipFile(&#39;/tmp/export.zip&#39;, &#39;w&#39;).AndReturn(mock_zip)
&nbsp;&nbsp;&nbsp; mock_zip.__enter__().AndReturn(mock_zip)
&nbsp;&nbsp;&nbsp; mock_zip.write(&#39;/tmp/export-1.xml&#39;, &#39;export-1.xml&#39;)
&nbsp;&nbsp;&nbsp; mock_zip.write(&#39;/tmp/export-2.xml&#39;, &#39;export-2.xml&#39;)
&nbsp;&nbsp;&nbsp; mock_zip.__exit__(None, None, None)

    self.mock.ReplayAll()
    zip_it_up()
    self.mock.VerifyAll()</code></pre><p>Mocking out ZipFile allows us to return a mock object from it's instantiation. We can then set the expectation that __enter__ will be called on the instance, returning the instance itself, expecting <code>write</code> to be called twice on the instance and finally __exit__ to be called. The three arguments of <code>None</code> here are to indicate that an exception isn't expected. If the code inside the context block were to raise an exception, these arguments would be the <code>type</code>, <code>value</code> and <code>traceback</code> as returned by <code>raise</code>. In the event you are testing for an exception, these arguments should be set accordingly when setting expectations.</p></div></article><aside class=col-md-4><nav class=social-icons><a href=https://github.com/jsatt rel=me target=_blank><i class="fa-brands fa-github" title="Github: jsatt"></i></a>
<a href=https://www.facebook.com/jsatt0 rel=me target=_blank><i class="fa-brands fa-facebook" title="Facebook: jsatt0"></i></a>
<a href=https://twitter.com/jsatt rel=me target=_blank><i class="fa-brands fa-twitter" title="Twitter: @jsatt"></i></a>
<a href=https://fosstodon.org/web/@jsatt rel=me target=_blank><i class="fa-brands fa-mastodon" title="Mastodon: @jsatt@fosstodon.org"></i></a>
<a href=https://www.linkedin.com/in/jsatterfield rel=me target=_blank><i class="fa-brands fa-linkedin" title="Linkedin: jsatterfield"></i></a>
<a href=mailto:jsatt@jsatt.com><i class="fa-solid fa-envelope" title="Email: jsatt@jsatt.com"></i></a>
<a href=https://jsatt.com/blog/feeds/rss/ target=_blank><i class="fa-solid fa-square-rss" title=RSS></i></a></nav><div id=related-posts><div class=related-post><a href=https://jsatt.com/blog/python-catalog/>Python Catalog Data Structures</a><div class=timesince>2017-11-10</div></div><div class=related-post><a href=https://jsatt.com/blog/virtualenvs-for-all/>Manage All the Languages Using Python Virtualenv</a><div class=timesince>2017-10-28</div></div><div class=related-post><a href=https://jsatt.com/blog/unit-testing-recursion-in-python/>Unit Testing Recursion in Python</a><div class=timesince>2014-12-11</div></div><div class=related-post><a href=https://jsatt.com/blog/mocking-a-property-in-python/>Mocking a property in Python</a><div class=timesince>2014-08-08</div></div><div class=related-post><a href=https://jsatt.com/blog/mocking-pythons-built-in-open-function/>Mocking Python&amp;#39;s built-in open function</a><div class=timesince>2014-04-11</div></div></div><div class=keywords><div class=keyword><a href=https://jsatt.com/tags/python/>#python</a></div><div class=keyword><a href=https://jsatt.com/tags/testing/>#testing</a></div><div class=keyword><a href=https://jsatt.com/tags/django/>#django</a></div><div class=keyword><a href=https://jsatt.com/tags/hacks/>#hacks</a></div><div class=keyword><a href=https://jsatt.com/tags/mocking/>#mocking</a></div><div class=keyword><a href=https://jsatt.com/tags/django-rest-framework/>#django-rest-framework</a></div><div class=keyword><a href=https://jsatt.com/tags/celery/>#celery</a></div><div class=keyword><a href=https://jsatt.com/tags/class-based-views/>#class-based-views</a></div><div class=keyword><a href=https://jsatt.com/tags/data-structures/>#data-structures</a></div><div class=keyword><a href=https://jsatt.com/tags/dev-ops/>#dev-ops</a></div><div class=keyword><a href=https://jsatt.com/tags/docker/>#docker</a></div><div class=keyword><a href=https://jsatt.com/tags/go/>#go</a></div><div class=keyword><a href=https://jsatt.com/tags/linux/>#linux</a></div><div class=keyword><a href=https://jsatt.com/tags/node/>#node</a></div><div class=keyword><a href=https://jsatt.com/tags/nose/>#nose</a></div><div class=keyword><a href=https://jsatt.com/tags/open-source/>#open-source</a></div><div class=keyword><a href=https://jsatt.com/tags/packages/>#packages</a></div><div class=keyword><a href=https://jsatt.com/tags/ruby/>#ruby</a></div><div class=keyword><a href=https://jsatt.com/tags/rust/>#rust</a></div><div class=keyword><a href=https://jsatt.com/tags/tox/>#tox</a></div><div class=keyword><a href=https://jsatt.com/tags/travis-ci/>#travis-ci</a></div><div class=keyword><a href=https://jsatt.com/tags/virtualenvs/>#virtualenvs</a></div></div></aside></div></div></section><footer><div class=container><div class=row><div class=col-md-12><div class=nav-footer><ul class=list-unstyled><li id=footer-menu-presentations><a href=https://jsatt.com/presentations/>Presentations</a></li><li id=footer-menu-resume><a href=https://jsatt.com/resume/>Resume</a></li></ul></div></div></div></div></footer><script src=../../static/js/jquery.min.js></script>
<script src=../../static/js/prism.js></script>
<script src=../../static/js/bootstrap.min.js></script></body></html>